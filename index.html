<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TokenOriginate | Credit Risk Scoring</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
<style>
/* ── Reset & base ── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f4f8; color: #0f172a;
       display: flex; height: 100vh; overflow: hidden; }

/* ── Sidebar ── */
#sidebar {
  width: 300px; min-width: 300px; background: #0c2340;
  height: 100vh; overflow-y: auto; padding: 1.4rem 1.2rem;
  display: flex; flex-direction: column; gap: 0; flex-shrink: 0;
}
#sidebar::-webkit-scrollbar { width: 4px; }
#sidebar::-webkit-scrollbar-thumb { background: #1e4976; border-radius: 4px; }

.sb-logo { color: white; font-size: 1.1rem; font-weight: 800; margin-bottom: .15rem; }
.sb-sub  { color: #5a8fb5; font-size: .72rem; font-weight: 600;
           text-transform: uppercase; letter-spacing: .8px; margin-bottom: 1rem; }
.sb-sep  { border: none; border-top: 1px solid #1e4976; margin: .9rem 0; }
.sb-sec  { font-size: .65rem; font-weight: 700; text-transform: uppercase;
           letter-spacing: .8px; color: #5a8fb5; margin-bottom: .6rem;
           padding-bottom: .3rem; border-bottom: 1px solid #1e4976; }

.field   { margin-bottom: .7rem; }
.field label { display: block; font-size: .68rem; font-weight: 700; color: #7eb8d8;
               text-transform: uppercase; letter-spacing: .5px; margin-bottom: .3rem; }
.field input, .field select {
  width: 100%; background: #163456; color: white; border: 1px solid #2a5580;
  border-radius: 6px; padding: .35rem .5rem; font-size: .85rem; outline: none;
}
.field input:focus, .field select:focus { border-color: #3b82f6; }
.field select option { background: #163456; color: white; }

/* Example buttons */
.ex-btns { display: flex; gap: .4rem; margin-bottom: .5rem; flex-wrap: wrap; }
.ex-btn  { flex: 1; min-width: 60px; background: #1e4976; color: #c8dff0; border: none; border-radius: 6px;
           padding: .45rem .3rem; font-size: .75rem; font-weight: 700; cursor: pointer;
           transition: background .15s; }
.ex-btn:hover { background: #2563ab; color: white; }

/* Action buttons */
.action-btn { width: 100%; margin-top: .5rem; background: #1d4ed8;
              color: white; border: none; border-radius: 6px;
              padding: .55rem; font-size: .85rem; font-weight: 700; cursor: pointer;
              transition: background .15s; }
.action-btn:hover { background: #1e40af; }
.reset-btn  { width: 100%; margin-top: .4rem; background: transparent;
              color: #5a8fb5; border: 1px solid #1e4976; border-radius: 6px;
              padding: .45rem; font-size: .82rem; font-weight: 600; cursor: pointer;
              transition: all .15s; }
.reset-btn:hover { background: #1e4976; color: #c8dff0; }

/* ── Main ── */
#main { flex: 1; overflow-y: auto; padding: 1.5rem 1.8rem; }
#main::-webkit-scrollbar { width: 6px; }
#main::-webkit-scrollbar-thumb { background: #c7d8eb; border-radius: 4px; }

.main-header { display: flex; justify-content: space-between; align-items: flex-start;
               margin-bottom: 1.5rem; }
.main-header h1 { font-size: 1.55rem; font-weight: 800; color: #0c2340; }
.main-header p  { font-size: .82rem; color: #64748b; margin-top: .2rem; }

/* ── Section tabs ── */
.tabs { display: flex; gap: .5rem; margin-bottom: 1.4rem; flex-wrap: wrap; }
.tab  { padding: .45rem 1.1rem; border-radius: 20px; font-size: .8rem; font-weight: 700;
        cursor: pointer; border: 2px solid transparent; transition: all .2s; }
.tab.active  { background: #1d4ed8; color: white; }
.tab.inactive{ background: white; color: #475569; border-color: #e2e8f0; }
.tab.inactive:hover { border-color: #1d4ed8; color: #1d4ed8; }

.section { display: none; }
.section.active { display: block; }

/* ── Gating Banner ── */
.gating-banner {
  background: linear-gradient(135deg, #7f1d1d, #991b1b);
  border-radius: 12px; padding: 1rem 1.4rem;
  margin-bottom: 1.5rem; display: none;
  animation: fadeIn .4s ease;
}
.gating-banner.visible { display: block; }
.gating-banner .g-title { font-size: .75rem; font-weight: 800; text-transform: uppercase;
                           letter-spacing: 1px; color: #fca5a5; margin-bottom: .4rem; }
.gating-banner .g-text  { font-size: .95rem; font-weight: 700; color: white; line-height: 1.5; }

/* ── KPI strip ── */
.kpi-strip { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px,1fr));
             gap: 1rem; margin-bottom: 1.4rem; }
.kpi { background: white; border-radius: 12px; padding: 1rem 1.1rem;
       box-shadow: 0 1px 4px rgba(0,0,0,.07); }
.kpi .k-label { font-size: .68rem; font-weight: 700; text-transform: uppercase;
                letter-spacing: .6px; color: #64748b; margin-bottom: .3rem; }
.kpi .k-value { font-size: 1.55rem; font-weight: 800; color: #0c2340; line-height: 1; }
.kpi .k-sub   { font-size: .72rem; color: #94a3b8; margin-top: .2rem; }

/* ── Score row ── */
.score-row { display: grid; grid-template-columns: 260px 1fr; gap: 1.2rem;
             margin-bottom: 1.4rem; }
@media (max-width: 900px) { .score-row { grid-template-columns: 1fr; } }

/* ── Charts grid ── */
.chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem;
              margin-bottom: 1.4rem; }
@media (max-width: 820px) { .chart-grid { grid-template-columns: 1fr; } }

.card { background: white; border-radius: 14px; padding: 1.2rem 1.4rem;
        box-shadow: 0 1px 6px rgba(0,0,0,.07); }
.card-title { font-size: .78rem; font-weight: 700; text-transform: uppercase;
              letter-spacing: .6px; color: #64748b; margin-bottom: 1rem; }

/* ── Ratio tiles ── */
.ratio-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr));
              gap: .8rem; margin-bottom: 1.4rem; }
.ratio-tile { background: white; border-radius: 10px; padding: .85rem 1rem;
              box-shadow: 0 1px 4px rgba(0,0,0,.07); border-top: 3px solid #e2e8f0;
              transition: transform .15s; }
.ratio-tile:hover { transform: translateY(-2px); }
.ratio-tile.verde   { border-top-color: #22c55e; }
.ratio-tile.amarillo{ border-top-color: #f59e0b; }
.ratio-tile.naranja { border-top-color: #f97316; }
.ratio-tile.rojo    { border-top-color: #ef4444; }
.rt-label { font-size: .65rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: .5px; color: #64748b; }
.rt-value { font-size: 1.4rem; font-weight: 800; color: #0c2340; margin: .2rem 0; }
.rt-sub   { font-size: .7rem; color: #94a3b8; }
.rt-score { font-size: .72rem; font-weight: 700; margin-top: .35rem;
            padding: .15rem .45rem; border-radius: 20px; display: inline-block; }
.verde    .rt-score { background: #dcfce7; color: #15803d; }
.amarillo .rt-score { background: #fef3c7; color: #92400e; }
.naranja  .rt-score { background: #ffedd5; color: #9a3412; }
.rojo     .rt-score { background: #fee2e2; color: #991b1b; }

/* LTV indicator in sidebar */
.ltv-indicator { border-radius: 6px; padding: .4rem .6rem; margin-top: .3rem;
                 font-size: .75rem; font-weight: 700; display: none; }
.ltv-ok   { background: #dcfce7; color: #15803d; display: block; }
.ltv-warn { background: #fef3c7; color: #92400e; display: block; }
.ltv-bad  { background: #fee2e2; color: #991b1b; display: block; }
.gating-badge { font-size: .6rem; font-weight: 800; text-transform: uppercase;
                background: #fbbf24; color: #78350f; padding: .1rem .35rem;
                border-radius: 4px; margin-left: .3rem; vertical-align: middle; }

/* ── Recommendation banner ── */
.rec-banner { border-radius: 14px; padding: 1.3rem 1.6rem; margin-bottom: 1.4rem;
              display: flex; align-items: flex-start; gap: 1.2rem; }
.rec-banner.verde    { background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-left: 5px solid #22c55e; }
.rec-banner.amarillo { background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 5px solid #f59e0b; }
.rec-banner.rojo     { background: linear-gradient(135deg, #fee2e2, #fecaca); border-left: 5px solid #ef4444; }
.rec-icon { font-size: 2.5rem; line-height: 1; }
.rec-body .rec-label { font-size: .72rem; font-weight: 700; text-transform: uppercase;
                        letter-spacing: .7px; color: #475569; margin-bottom: .25rem; }
.rec-body .rec-decision { font-size: 1.5rem; font-weight: 900; margin-bottom: .3rem; }
.verde .rec-decision    { color: #15803d; }
.amarillo .rec-decision { color: #92400e; }
.rojo .rec-decision     { color: #991b1b; }
.rec-body .rec-text { font-size: .9rem; color: #374151; line-height: 1.6; }

/* ── Risk factors ── */
.risk-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr));
             gap: 1rem; margin-bottom: 1.4rem; }
.risk-card { background: white; border-radius: 12px; padding: 1rem 1.2rem;
             box-shadow: 0 1px 4px rgba(0,0,0,.07); border-left: 4px solid #ef4444; }
.risk-card .r-rank  { font-size: .65rem; font-weight: 800; text-transform: uppercase;
                       color: #ef4444; letter-spacing: .5px; }
.risk-card .r-name  { font-size: .92rem; font-weight: 700; color: #0c2340; margin: .2rem 0; }
.risk-card .r-value { font-size: .8rem; color: #64748b; }
.risk-card .r-impact{ font-size: .78rem; font-weight: 700; color: #dc2626; margin-top: .3rem; }

/* ── Nueva Deuda section ── */
.nueva-deuda-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem; margin-bottom: 1.4rem; }
@media (max-width: 820px) { .nueva-deuda-grid { grid-template-columns: 1fr; } }

.nd-result { background: white; border-radius: 14px; padding: 1.2rem 1.4rem;
             box-shadow: 0 1px 6px rgba(0,0,0,.07); }
.nd-row { display: flex; justify-content: space-between; align-items: center;
          padding: .5rem 0; border-bottom: 1px solid #f1f5f9; }
.nd-row:last-child { border-bottom: none; }
.nd-lbl { font-size: .8rem; color: #64748b; }
.nd-val { font-size: .9rem; font-weight: 700; color: #0c2340; }
.nd-status { padding: .2rem .7rem; border-radius: 20px; font-size: .78rem; font-weight: 700; }
.nd-ok   { background: #dcfce7; color: #15803d; }
.nd-warn { background: #fef3c7; color: #92400e; }
.nd-bad  { background: #fee2e2; color: #991b1b; }

/* ── Sector comparables ── */
.sect-table { width: 100%; border-collapse: collapse; font-size: .82rem; }
.sect-table th { background: #f8fafc; font-size: .68rem; font-weight: 700;
                 text-transform: uppercase; letter-spacing: .5px; color: #64748b;
                 padding: .6rem .8rem; text-align: left; }
.sect-table td { padding: .55rem .8rem; border-bottom: 1px solid #f1f5f9; }
.sect-table tr:last-child td { border-bottom: none; }
.sect-table tr.company-row td { background: #eff6ff; font-weight: 700; color: #1d4ed8; }
.pos-p25  { color: #15803d; font-weight: 700; }
.pos-med  { color: #92400e; font-weight: 700; }
.pos-p75  { color: #991b1b; font-weight: 700; }
.pos-good { color: #15803d; }
.pos-mid  { color: #92400e; }
.pos-bad  { color: #991b1b; }

/* ── Covenants ── */
.cov-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
            gap: .9rem; margin-bottom: 1.2rem; }
.cov-card { background: white; border-radius: 12px; padding: 1rem 1.2rem;
            box-shadow: 0 1px 4px rgba(0,0,0,.07); border-left: 4px solid #1d4ed8; }
.cov-name  { font-size: .68rem; font-weight: 700; text-transform: uppercase;
             letter-spacing: .5px; color: #64748b; margin-bottom: .4rem; }
.cov-value { font-size: 1.25rem; font-weight: 800; color: #0c2340; }
.cov-desc  { font-size: .75rem; color: #94a3b8; margin-top: .3rem; }

.pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
                gap: .9rem; margin-bottom: 1rem; }
.pricing-card { background: #f8fafc; border-radius: 10px; padding: .8rem 1rem;
                border: 1px solid #e2e8f0; text-align: center; }
.pricing-card.active-price { background: #eff6ff; border-color: #3b82f6; }
.pc-tranche { font-size: .68rem; font-weight: 700; text-transform: uppercase;
              letter-spacing: .5px; color: #64748b; margin-bottom: .3rem; }
.pc-spread  { font-size: 1.2rem; font-weight: 800; color: #1d4ed8; }
.pc-note    { font-size: .72rem; color: #94a3b8; margin-top: .2rem; }

/* ── Detail table ── */
.det-table { width: 100%; border-collapse: collapse; font-size: .83rem; }
.det-table th { background: #f8fafc; font-size: .68rem; font-weight: 700;
                text-transform: uppercase; letter-spacing: .5px; color: #64748b;
                padding: .65rem .9rem; text-align: left; }
.det-table td { padding: .6rem .9rem; border-bottom: 1px solid #f1f5f9; }
.det-table tr:last-child td { border-bottom: none; }
.badge-v { background: #dcfce7; color: #15803d; padding: .15rem .5rem;
           border-radius: 20px; font-size: .72rem; font-weight: 700; }
.badge-a { background: #fef3c7; color: #92400e; padding: .15rem .5rem;
           border-radius: 20px; font-size: .72rem; font-weight: 700; }
.badge-r { background: #fee2e2; color: #991b1b; padding: .15rem .5rem;
           border-radius: 20px; font-size: .72rem; font-weight: 700; }
.badge-n { background: #ffedd5; color: #9a3412; padding: .15rem .5rem;
           border-radius: 20px; font-size: .72rem; font-weight: 700; }
.badge-g { background: #fbbf24; color: #78350f; padding: .15rem .5rem;
           border-radius: 20px; font-size: .72rem; font-weight: 700; }

/* ── Colateral inventory table ── */
.col-table { width:100%; border-collapse:collapse; font-size:.82rem; }
.col-table th { background:#f8fafc; font-size:.67rem; font-weight:700; text-transform:uppercase;
                letter-spacing:.5px; color:#64748b; padding:.55rem .7rem; text-align:left; white-space:nowrap; }
.col-table td { padding:.42rem .7rem; border-bottom:1px solid #f1f5f9; vertical-align:middle; }
.col-table tfoot td { padding:.6rem .7rem; font-weight:800; }
.col-inp { background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px;
           padding:.28rem .4rem; font-size:.8rem; font-family:inherit; }
.col-inp:focus { border-color:#3b82f6; outline:none; }
.col-inp-desc { width:140px; }
.col-inp-num  { width:70px; text-align:right; }
.col-sel { width:155px; }
.col-haircut { text-align:center; font-weight:700; color:#f97316; }
.col-neto    { text-align:right; font-weight:800; color:#0c2340; }
.col-del-btn { background:none; border:none; color:#ef4444; font-size:1.1rem;
               cursor:pointer; padding:.1rem .3rem; line-height:1; }
.col-del-btn:hover { color:#991b1b; }

/* ── Recovery metric cards ── */
.rec-kpi-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
                gap:.9rem; margin-bottom:1.2rem; }
.rec-kpi { background:white; border-radius:12px; padding:.9rem 1rem;
           box-shadow:0 1px 4px rgba(0,0,0,.07); border-top:3px solid #e2e8f0; }
.rec-kpi.rv  { border-top-color:#22c55e; }
.rec-kpi.ra  { border-top-color:#f59e0b; }
.rec-kpi.rn  { border-top-color:#f97316; }
.rec-kpi.rr  { border-top-color:#ef4444; }
.rec-kpi.rb  { border-top-color:#1d4ed8; }
.rk-label { font-size:.63rem; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:#64748b; margin-bottom:.3rem; }
.rk-value { font-size:1.3rem; font-weight:800; color:#0c2340; line-height:1; }
.rk-sub   { font-size:.68rem; color:#94a3b8; margin-top:.25rem; }

/* ── Priority table ── */
.pri-covered { background:#f0fdf4; }
.pri-partial { background:#fefce8; }

/* ── Animations ── */
@keyframes fadeIn { from { opacity:0; transform: translateY(-8px); } to { opacity:1; transform:none; } }

/* ── PDF / Print button ── */
.pdf-btn { width: 100%; margin-top: .4rem; background: #0f172a;
           color: #7eb8d8; border: 1px solid #1e4976; border-radius: 6px;
           padding: .45rem; font-size: .82rem; font-weight: 600; cursor: pointer;
           transition: all .15s; display: flex; align-items: center;
           justify-content: center; gap: .4rem; }
.pdf-btn:hover { background: #1e293b; color: #c8dff0; }

/* ── TokenOriginate branding ── */
.sb-branding { display: flex; align-items: center; gap: .75rem; margin-bottom: 1.1rem; }
.sb-logo-name { color: white; font-size: 1.05rem; font-weight: 800; letter-spacing: -.3px; line-height: 1.1; }
.sb-logo-tag  { color: #2dd4bf; font-size: .62rem; font-weight: 700; text-transform: uppercase;
                letter-spacing: .9px; margin-top: .1rem; }

/* ── PDF Cover page ── */
#pdf-cover {
  display: none;
  position: fixed; inset: 0; z-index: 9999;
  background: linear-gradient(145deg, #060e1d 0%, #0c1f3f 45%, #0e2d54 100%);
  flex-direction: column; align-items: center; justify-content: center;
  font-family: 'Segoe UI', Arial, sans-serif; color: white;
}
.cover-grid-bg {
  position: absolute; inset: 0; opacity: .04;
  background-image: linear-gradient(#fff 1px, transparent 1px),
                    linear-gradient(90deg, #fff 1px, transparent 1px);
  background-size: 40px 40px;
}
.cover-accent-bar {
  position: absolute; top: 0; left: 0; right: 0; height: 4px;
  background: linear-gradient(90deg, #2dd4bf, #3b82f6, #f59e0b);
}
.cover-accent-bottom {
  position: absolute; bottom: 0; left: 0; right: 0; height: 4px;
  background: linear-gradient(90deg, #f59e0b, #3b82f6, #2dd4bf);
}
.cover-logo-wrap { display: flex; align-items: center; gap: 1.2rem; margin-bottom: 2.5rem; }
.cover-company   { font-size: 2.8rem; font-weight: 900; letter-spacing: -1px; color: white; }
.cover-tagline   { font-size: .9rem; font-weight: 600; color: #2dd4bf; text-transform: uppercase;
                   letter-spacing: 2px; margin-top: .2rem; }
.cover-divider   { width: 80px; height: 3px;
                   background: linear-gradient(90deg, #3b82f6, #2dd4bf);
                   border-radius: 2px; margin: 2rem 0; }
.cover-report    { font-size: 1.55rem; font-weight: 800; color: white;
                   text-align: center; letter-spacing: -.5px; }
.cover-sub       { font-size: .95rem; color: #94a3b8; margin-top: .6rem; text-align: center; }
.cover-meta      { display: flex; gap: 2.5rem; margin-top: 3rem; }
.cover-meta-item { text-align: center; }
.cover-meta-item .cm-label { font-size: .65rem; font-weight: 700; text-transform: uppercase;
                              letter-spacing: 1px; color: #64748b; margin-bottom: .3rem; }
.cover-meta-item .cm-value { font-size: .95rem; font-weight: 700; color: #e2e8f0; }
.cover-footer-txt { position: absolute; bottom: 1.5rem; font-size: .72rem;
                    color: #334155; text-align: center; letter-spacing: .5px; }

/* ── Print ── */
@media print {
  #pdf-cover { display: flex !important; position: relative;
               width: 100vw; height: 100vh; page-break-after: always; }
  #sidebar { display: none; }
  body { overflow: auto; display: block; background: white; }
  #main { overflow: visible; padding: 1rem; }
  .tabs { display: none; }
  .section { display: block !important; page-break-inside: avoid; margin-bottom: 2rem; }
  .section::before { content: attr(data-title); font-size: 1rem; font-weight: 800;
                     color: #0c2340; display: block; margin-bottom: .8rem;
                     border-bottom: 2px solid #0c2340; padding-bottom: .3rem; }
  .print-header { display: flex !important; }
}
</style>
</head>
<body>

<!-- ═══════════════════════════ PDF COVER ═══════════════════════════ -->
<div id="pdf-cover">
  <div class="cover-grid-bg"></div>
  <div class="cover-accent-bar"></div>
  <div class="cover-accent-bottom"></div>
  <div class="cover-logo-wrap">
    <!-- TokenOriginate Logo SVG -->
    <svg width="72" height="72" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="cvGrad" x1="0" y1="0" x2="72" y2="72" gradientUnits="userSpaceOnUse">
          <stop offset="0%" stop-color="#1e40af"/>
          <stop offset="50%" stop-color="#2563eb"/>
          <stop offset="100%" stop-color="#0ea5e9"/>
        </linearGradient>
        <linearGradient id="cvGoldGrad" x1="0" y1="0" x2="72" y2="0" gradientUnits="userSpaceOnUse">
          <stop offset="0%" stop-color="#f59e0b"/>
          <stop offset="100%" stop-color="#fbbf24"/>
        </linearGradient>
      </defs>
      <rect width="72" height="72" rx="18" fill="url(#cvGrad)"/>
      <!-- Outer diamond / token shape -->
      <polygon points="36,10 62,36 36,62 10,36" fill="none" stroke="white" stroke-width="2" opacity="0.35"/>
      <!-- Inner diamond -->
      <polygon points="36,20 52,36 36,52 20,36" fill="none" stroke="white" stroke-width="1.5" opacity="0.18"/>
      <!-- Originate arrow -->
      <line x1="22" y1="36" x2="44" y2="36" stroke="url(#cvGoldGrad)" stroke-width="3.5" stroke-linecap="round"/>
      <polyline points="38,28 46,36 38,44" fill="none" stroke="url(#cvGoldGrad)" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/>
      <!-- Corner dots -->
      <circle cx="36" cy="10" r="3" fill="#2dd4bf"/>
      <circle cx="62" cy="36" r="3" fill="#2dd4bf"/>
      <circle cx="36" cy="62" r="3" fill="#2dd4bf"/>
      <circle cx="10" cy="36" r="3" fill="#2dd4bf"/>
    </svg>
    <div>
      <div class="cover-company">TokenOriginate</div>
      <div class="cover-tagline">Credit Risk Platform</div>
    </div>
  </div>
  <div class="cover-divider"></div>
  <div class="cover-report">Credit Risk Scoring Report</div>
  <div class="cover-sub">PYMEs Industriales — Modelo v2.0 | Análisis de Riesgo Crediticio</div>
  <div class="cover-meta">
    <div class="cover-meta-item">
      <div class="cm-label">Fecha de análisis</div>
      <div class="cm-value" id="cover-date">—</div>
    </div>
    <div class="cover-meta-item">
      <div class="cm-label">Plataforma</div>
      <div class="cm-value">TokenOriginate v2.0</div>
    </div>
    <div class="cover-meta-item">
      <div class="cm-label">Clasificación</div>
      <div class="cm-value">Uso Interno</div>
    </div>
  </div>
  <div class="cover-footer-txt">© TokenOriginate — Documento confidencial. Solo para uso interno y análisis orientativo. Prohibida su distribución sin autorización.</div>
</div>

<!-- ═══════════════════════════ SIDEBAR ═══════════════════════════ -->
<div id="sidebar">
  <!-- TokenOriginate brand -->
  <div class="sb-branding">
    <svg width="38" height="38" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="sbGrad" x1="0" y1="0" x2="72" y2="72" gradientUnits="userSpaceOnUse">
          <stop offset="0%" stop-color="#1e40af"/><stop offset="100%" stop-color="#0ea5e9"/>
        </linearGradient>
        <linearGradient id="sbGold" x1="0" y1="0" x2="72" y2="0" gradientUnits="userSpaceOnUse">
          <stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="#fbbf24"/>
        </linearGradient>
      </defs>
      <rect width="72" height="72" rx="18" fill="url(#sbGrad)"/>
      <polygon points="36,10 62,36 36,62 10,36" fill="none" stroke="white" stroke-width="2" opacity="0.35"/>
      <line x1="22" y1="36" x2="44" y2="36" stroke="url(#sbGold)" stroke-width="3.5" stroke-linecap="round"/>
      <polyline points="38,28 46,36 38,44" fill="none" stroke="url(#sbGold)" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="36" cy="10" r="3" fill="#2dd4bf"/>
      <circle cx="62" cy="36" r="3" fill="#2dd4bf"/>
      <circle cx="36" cy="62" r="3" fill="#2dd4bf"/>
      <circle cx="10" cy="36" r="3" fill="#2dd4bf"/>
    </svg>
    <div>
      <div class="sb-logo-name">TokenOriginate</div>
      <div class="sb-logo-tag">Credit Risk Platform</div>
    </div>
  </div>

  <!-- Example buttons -->
  <div class="sb-sec">Cargar ejemplo</div>
  <div class="ex-btns">
    <button class="ex-btn" onclick="loadExample('tubacex')">Tubacex</button>
    <button class="ex-btn" onclick="loadExample('aa')">Perfil AA</button>
    <button class="ex-btn" onclick="loadExample('c')">Perfil C</button>
  </div>
  <hr class="sb-sep">

  <!-- P&L -->
  <div class="sb-sec">Cuenta de Resultados (M€)</div>
  <div class="field"><label>Ventas netas</label><input type="number" id="ventas" step="0.1" value="100"></div>
  <div class="field"><label>EBITDA reportado</label><input type="number" id="ebitda" step="0.1" value="15"></div>
  <div class="field"><label>Gastos financieros</label><input type="number" id="gastos_fin" step="0.1" value="2.5"></div>
  <div class="field"><label>Impuesto pagado (caja)</label><input type="number" id="imp_pagado" step="0.1" value="2"></div>
  <div class="field"><label>Capex mantenimiento</label><input type="number" id="capex_mant" step="0.1" value="2"></div>

  <hr class="sb-sep">
  <!-- Balance -->
  <div class="sb-sec">Balance (M€)</div>
  <div class="field"><label>Deuda financiera bruta</label><input type="number" id="deuda_bruta" step="0.1" value="35"></div>
  <div class="field"><label>Caja y equiv.</label><input type="number" id="caja" step="0.1" value="8"></div>
  <div class="field"><label>Activo corriente</label><input type="number" id="activo_corriente" step="0.1" value="45"></div>
  <div class="field"><label>Pasivo corriente</label><input type="number" id="pasivo_corriente" step="0.1" value="28"></div>
  <div class="field"><label>Clientes (cobrar)</label><input type="number" id="clientes" step="0.1" value="22"></div>
  <div class="field"><label>Proveedores (pagar)</label><input type="number" id="proveedores" step="0.1" value="18"></div>
  <div class="field"><label>Vida media deuda (años)</label><input type="number" id="vida_media" step="0.5" value="5"></div>

  <hr class="sb-sep">
  <!-- Operación nueva -->
  <div class="sb-sec">Operación Nueva (opcional)</div>
  <div class="field"><label>Importe solicitado (M€)</label><input type="number" id="importe" step="0.1" value="0" oninput="updateLtvIndicator()"></div>
  <div class="field"><label>Plazo (años)</label><input type="number" id="plazo" step="1" value="5"></div>
  <div class="field"><label>Tipo interés (%)</label><input type="number" id="tipo_int" step="0.1" value="6"></div>

  <hr class="sb-sep">
  <!-- Colateral -->
  <div class="sb-sec">Colateral</div>
  <div class="field"><label>Valor colateral (M€)</label><input type="number" id="colateral" step="0.1" value="0" oninput="updateLtvIndicator()"></div>
  <div class="field">
    <label>Tipo colateral</label>
    <select id="tipo_col" onchange="updateLtvIndicator()">
      <option value="inmueble">Inmueble (LTV máx. 60%)</option>
      <option value="maquinaria">Maquinaria (LTV máx. 40%)</option>
      <option value="cuentas_cobrar">Cuentas a cobrar (LTV máx. 70%)</option>
      <option value="stock">Stock (LTV máx. 50%)</option>
      <option value="mixto">Mixto (LTV máx. 55%)</option>
      <option value="ninguno">Sin colateral</option>
    </select>
  </div>
  <div id="ltv-indicator" class="ltv-indicator"></div>

  <hr class="sb-sep">
  <!-- Cualitativos -->
  <div class="sb-sec">Factores Cualitativos (1–5)</div>
  <div class="field">
    <label>Equipo directivo</label>
    <select id="equipo">
      <option value="3">3 – Competente</option>
      <option value="1">1 – Deficiente</option>
      <option value="2">2 – Limitado</option>
      <option value="4">4 – Sólido</option>
      <option value="5">5 – Excelente</option>
    </select>
  </div>
  <div class="field">
    <label>Diversif. clientes</label>
    <select id="concentracion">
      <option value="3">3 – Media (top-3 ~50%)</option>
      <option value="1">1 – Muy alta (top-1 > 60%)</option>
      <option value="2">2 – Alta (top-3 > 70%)</option>
      <option value="4">4 – Baja (top-3 < 40%)</option>
      <option value="5">5 – Muy baja (top-3 < 20%)</option>
    </select>
  </div>
  <div class="field">
    <label>Antigüedad negocio</label>
    <select id="antiguedad">
      <option value="3">3 – 10–20 años</option>
      <option value="1">1 – < 3 años</option>
      <option value="2">2 – 3–10 años</option>
      <option value="4">4 – 20–30 años</option>
      <option value="5">5 – > 30 años</option>
    </select>
  </div>
  <div class="field">
    <label>Estabilidad sector</label>
    <select id="ciclicidad">
      <option value="3">3 – Moderada</option>
      <option value="1">1 – Muy cíclico</option>
      <option value="2">2 – Cíclico</option>
      <option value="4">4 – Estable</option>
      <option value="5">5 – Muy defensivo</option>
    </select>
  </div>

  <hr class="sb-sep">
  <!-- Sector comparables -->
  <div class="sb-sec">Sector para comparables</div>
  <div class="field">
    <select id="sector_comp">
      <option value="metalurgia">Metalurgia / Fab. metal</option>
      <option value="quimica">Química / Plásticos</option>
      <option value="alimentacion">Alimentación / Bebidas</option>
      <option value="automocion">Automoción / Componentes</option>
      <option value="papel_carton">Papel / Cartón</option>
      <option value="construccion">Construcción industrial</option>
      <option value="energia">Energía / Renovables</option>
      <option value="logistica">Logística / Transporte</option>
    </select>
  </div>

  <hr class="sb-sep">
  <button class="action-btn" onclick="update()">Calcular scoring</button>
  <button class="reset-btn" onclick="resetForm()">Nueva valoración</button>
  <button class="pdf-btn" onclick="exportPDF()">⬇ Descargar PDF</button>
</div>

<!-- ═══════════════════════════ MAIN ═══════════════════════════ -->
<div id="main">
  <!-- Print-only header strip (appears on every page after cover) -->
  <div class="print-header" style="display:none; justify-content:space-between; align-items:center;
       border-bottom:2px solid #0c1f3f; padding-bottom:.6rem; margin-bottom:1.2rem;">
    <div style="display:flex;align-items:center;gap:.6rem;">
      <svg width="24" height="24" viewBox="0 0 72 72" fill="none">
        <defs>
          <linearGradient id="phGrad" x1="0" y1="0" x2="72" y2="72" gradientUnits="userSpaceOnUse">
            <stop offset="0%" stop-color="#1e40af"/><stop offset="100%" stop-color="#0ea5e9"/>
          </linearGradient>
        </defs>
        <rect width="72" height="72" rx="18" fill="url(#phGrad)"/>
        <polygon points="36,10 62,36 36,62 10,36" fill="none" stroke="white" stroke-width="2" opacity="0.4"/>
        <line x1="22" y1="36" x2="44" y2="36" stroke="#f59e0b" stroke-width="3.5" stroke-linecap="round"/>
        <polyline points="38,28 46,36 38,44" fill="none" stroke="#f59e0b" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span style="font-weight:800;font-size:.9rem;color:#0c1f3f;">TokenOriginate</span>
      <span style="font-size:.75rem;color:#64748b;">Credit Risk Platform</span>
    </div>
    <span style="font-size:.72rem;color:#94a3b8;">Credit Risk Scoring Report — Uso interno</span>
  </div>

  <div class="main-header">
    <div>
      <h1>Credit Risk Scoring</h1>
      <p id="subtitle">TokenOriginate — PYMEs Industriales v2.0 | Solo uso interno y análisis orientativo</p>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active"   onclick="switchTab('scoring')">Scoring</div>
    <div class="tab inactive" onclick="switchTab('nueva_deuda')">Nueva Deuda</div>
    <div class="tab inactive" onclick="switchTab('comparables')">Comparables</div>
    <div class="tab inactive" onclick="switchTab('covenants')">Covenants</div>
    <div class="tab inactive" onclick="switchTab('colateral')">Colateral</div>
    <div class="tab inactive" onclick="switchTab('detalle')">Detalle</div>
  </div>

  <!-- ── TAB: SCORING ── -->
  <div id="tab-scoring" class="section active" data-title="Scoring de Riesgo Crediticio">

    <!-- Gating banner -->
    <div id="gating-banner" class="gating-banner">
      <div class="g-title">⛔ GATING METRIC — RECHAZO AUTOMÁTICO</div>
      <div id="gating-text" class="g-text"></div>
    </div>

    <!-- KPI strip -->
    <div class="kpi-strip">
      <div class="kpi">
        <div class="k-label">EBITDA</div>
        <div class="k-value" id="kpi-ebitda">—</div>
        <div class="k-sub">M€ reportado</div>
      </div>
      <div class="kpi">
        <div class="k-label">Margen EBITDA</div>
        <div class="k-value" id="kpi-margin">—</div>
        <div class="k-sub">% sobre ventas</div>
      </div>
      <div class="kpi">
        <div class="k-label">DFN</div>
        <div class="k-value" id="kpi-dfn">—</div>
        <div class="k-sub">M€ deuda neta</div>
      </div>
      <div class="kpi">
        <div class="k-label">DFN / EBITDA</div>
        <div class="k-value" id="kpi-le">—</div>
        <div class="k-sub">x apalancamiento</div>
      </div>
      <div class="kpi">
        <div class="k-label">DSCR</div>
        <div class="k-value" id="kpi-dscr">—</div>
        <div class="k-sub">x cobertura deuda</div>
      </div>
      <div class="kpi">
        <div class="k-label">LLCR</div>
        <div class="k-value" id="kpi-llcr">—</div>
        <div class="k-sub">x loan life coverage</div>
      </div>
    </div>

    <!-- Score row: gauge + bar -->
    <div class="score-row">
      <div class="card">
        <div class="card-title">Score Global</div>
        <div id="gauge-chart" style="height:210px;"></div>
      </div>
      <div class="card">
        <div class="card-title">Contribución por Métrica</div>
        <div id="bar-chart" style="height:210px;"></div>
      </div>
    </div>

    <!-- Recommendation banner -->
    <div id="rec-banner" class="rec-banner verde">
      <div class="rec-icon" id="rec-icon">—</div>
      <div class="rec-body">
        <div class="rec-label">Decisión de crédito</div>
        <div class="rec-decision" id="rec-decision">—</div>
        <div class="rec-text" id="rec-text">—</div>
      </div>
    </div>

    <!-- Ratio tiles -->
    <div class="ratio-grid" id="ratio-grid"></div>

    <!-- Radar chart -->
    <div class="card" style="margin-bottom:1.4rem;">
      <div class="card-title">Perfil de Riesgo — Radar</div>
      <div id="radar-chart" style="height:300px;"></div>
    </div>

    <!-- Top risk factors -->
    <div class="card-title" style="margin-bottom:.8rem;">Top 3 Factores de Riesgo</div>
    <div class="risk-grid" id="risk-grid"></div>

  </div><!-- /tab-scoring -->

  <!-- ── TAB: NUEVA DEUDA ── -->
  <div id="tab-nueva_deuda" class="section" data-title="Análisis Nueva Deuda">
    <div class="nueva-deuda-grid">
      <div class="nd-result card">
        <div class="card-title">Análisis de Servicio de Deuda Nueva</div>
        <div id="nd-content">
          <p style="color:#94a3b8;font-size:.85rem;">Introduzca importe, plazo y tipo de interés en el panel lateral para ver el análisis.</p>
        </div>
      </div>
      <div class="nd-result card">
        <div class="card-title">Capacidad de Endeudamiento</div>
        <div id="nd-capacity"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Análisis LTV Colateral</div>
      <div id="nd-ltv"></div>
    </div>
  </div>

  <!-- ── TAB: COMPARABLES ── -->
  <div id="tab-comparables" class="section" data-title="Comparables Sectoriales">
    <div class="card" style="margin-bottom:1.2rem;">
      <div class="card-title">Comparables Sectoriales — <span id="sect-name">—</span></div>
      <div style="overflow-x:auto;">
        <table class="sect-table" id="sect-table">
          <thead><tr>
            <th>Métrica</th>
            <th>P25 Sector</th>
            <th>Mediana Sector</th>
            <th>P75 Sector</th>
            <th>Esta empresa</th>
            <th>Posición</th>
          </tr></thead>
          <tbody id="sect-tbody"></tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Posicionamiento Sectorial</div>
      <div id="sect-chart" style="height:280px;"></div>
    </div>
  </div>

  <!-- ── TAB: COVENANTS ── -->
  <div id="tab-covenants" class="section">
    <div style="margin-bottom:1.2rem;">
      <div class="card-title" style="margin-bottom:.8rem;">Covenants Financieros Sugeridos</div>
      <div class="cov-grid" id="cov-grid"></div>
    </div>
    <div class="card" style="margin-bottom:1.2rem;">
      <div class="card-title">Pricing por Tramo (Spread sobre Euribor)</div>
      <div class="pricing-grid" id="pricing-grid"></div>
      <p id="pricing-note" style="font-size:.78rem;color:#94a3b8;margin-top:.8rem;"></p>
    </div>
    <div class="card">
      <div class="card-title">Condiciones Adicionales Recomendadas</div>
      <div id="cov-extra"></div>
    </div>
  </div>

  <!-- ── TAB: COLATERAL ── -->
  <div id="tab-colateral" class="section" data-title="Análisis de Colateral y Recovery">

    <!-- S1: Inventory -->
    <div class="card" style="margin-bottom:1.2rem;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <div class="card-title" style="margin-bottom:0;">Sección 1 — Inventario de Colaterales</div>
        <button onclick="addColRow()" style="background:#1d4ed8;color:white;border:none;border-radius:8px;padding:.4rem .9rem;font-size:.8rem;font-weight:700;cursor:pointer;">+ Añadir activo</button>
      </div>
      <div style="overflow-x:auto;">
        <table class="col-table">
          <thead><tr>
            <th>Tipo de activo</th>
            <th>Descripción</th>
            <th style="text-align:right;">Valor bruto (M€)</th>
            <th style="text-align:center;">Haircut</th>
            <th style="text-align:right;">Valor neto (M€)</th>
            <th>Tiempo ejecución</th>
            <th></th>
          </tr></thead>
          <tbody id="col-tbody">
            <tr id="col-empty"><td colspan="7" style="text-align:center;color:#94a3b8;padding:1.8rem;font-size:.85rem;">Sin activos. Pulsa "+ Añadir activo" para comenzar.</td></tr>
          </tbody>
          <tfoot id="col-tfoot" style="display:none;">
            <tr style="background:#f8fafc;border-top:2px solid #e2e8f0;">
              <td colspan="2" style="color:#0c2340;">TOTAL</td>
              <td style="text-align:right;font-size:1rem;color:#0c2340;" id="col-t-bruto">0.00</td>
              <td></td>
              <td style="text-align:right;font-size:1rem;color:#15803d;" id="col-t-neto">0.00</td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- S2: Recovery metrics -->
    <div id="col-s2" style="display:none;margin-bottom:1.2rem;">
      <div class="card-title" style="margin-bottom:.8rem;">Sección 2 — Métricas de Recovery</div>
      <div class="rec-kpi-grid" id="col-kpis"></div>
    </div>

    <!-- S3: Waterfall -->
    <div id="col-s3" class="card" style="display:none;margin-bottom:1.2rem;">
      <div class="card-title">Sección 3 — Waterfall de Recuperación</div>
      <div id="col-waterfall" style="height:300px;"></div>
    </div>

    <!-- S4: Priority -->
    <div id="col-s4" class="card" style="display:none;">
      <div class="card-title">Sección 4 — Análisis de Prioridad de Cobro</div>
      <div style="overflow-x:auto;">
        <table class="col-table">
          <thead><tr>
            <th>#</th><th>Tipo</th><th>Descripción</th>
            <th>Tiempo ejecución</th>
            <th style="text-align:right;">Recuperable PV (M€)</th>
            <th style="text-align:right;">Cobertura acum.</th>
            <th>Estado</th>
          </tr></thead>
          <tbody id="col-priority"></tbody>
        </table>
      </div>
      <p id="col-note" style="font-size:.75rem;color:#94a3b8;margin-top:.8rem;">
        Valores presentes descontados al 8% según tiempo medio de ejecución estimado por tipo de activo.
      </p>
    </div>

  </div><!-- /tab-colateral -->

  <!-- ── TAB: DETALLE ── -->
  <div id="tab-detalle" class="section">
    <div class="card">
      <div class="card-title">Detalle Completo del Scoring</div>
      <div style="overflow-x:auto;">
        <table class="det-table">
          <thead><tr>
            <th>Métrica</th><th>Valor</th><th>Puntuación (0–100)</th><th>Peso</th><th>Contribución</th><th>Semáforo</th>
          </tr></thead>
          <tbody id="det-tbody"></tbody>
          <tfoot>
            <tr style="font-weight:800;background:#f8fafc;">
              <td colspan="3">Score Total</td>
              <td>100%</td>
              <td id="det-total">—</td>
              <td id="det-semaforo">—</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

</div><!-- /main -->

<script>
// ═══════════════════════════════════════════════════════════════
// SCORING MODEL v2
// ═══════════════════════════════════════════════════════════════

const PESOS = {
  dscr:          { peso: 25.0, nombre: 'DSCR',             gating: true  },
  deuda_ebitda:  { peso: 20.0, nombre: 'DFN / EBITDA',     gating: true  },
  llcr:          { peso: 15.0, nombre: 'LLCR',             gating: false },
  ebitda_margin: { peso: 10.0, nombre: 'Margen EBITDA',    gating: false },
  ltv:           { peso: 10.0, nombre: 'LTV Colateral',    gating: false },
  ffo_dfn:       { peso: 10.0, nombre: 'FFO / DFN',        gating: false },
  dias_cobro:    { peso:  5.0, nombre: 'Días de Cobro',    gating: false },
  equipo:        { peso:  1.25,nombre: 'Equipo Directivo', gating: false },
  concentracion: { peso:  1.25,nombre: 'Diversif. Clientes',gating: false },
  antiguedad:    { peso:  1.25,nombre: 'Antigüedad Negocio',gating: false },
  ciclicidad:    { peso:  1.25,nombre: 'Estabilidad Sector',gating: false },
};

// Linear interpolation between breakpoints [[v0,p0],[v1,p1],...]
function linScore(v, pts) {
  if (v <= pts[0][0]) return pts[0][1];
  if (v >= pts[pts.length-1][0]) return pts[pts.length-1][1];
  for (let i = 0; i < pts.length-1; i++) {
    const [v0,p0] = pts[i], [v1,p1] = pts[i+1];
    if (v >= v0 && v <= v1) return Math.round(p0 + (p1-p0)*(v-v0)/(v1-v0));
  }
  return 0;
}

// LTV max by collateral type (shared across calc functions)
const LTV_MAX = { inmueble:60, maquinaria:40, cuentas_cobrar:70, stock:50, mixto:55, ninguno:null };

const SCORE_FNS = {
  // DSCR: Rojo<1.0x(0-19), Naranja 1.0-1.2x(20-49), Amarillo 1.2-1.5x(50-79), Verde>1.5x(80-100)
  dscr:          v => linScore(v, [[0,0],[1.0,19],[1.2,49],[1.5,80],[2.5,100]]),
  deuda_ebitda:  v => v < 0 ? 100 : linScore(v, [[0,100],[2.5,80],[4.0,40],[7.0,0]]),
  // LLCR: Rojo<1.0x(0-19), Naranja 1.0-1.2x(20-49), Amarillo 1.2-1.4x(50-79), Verde>1.4x(80-100)
  llcr:          v => linScore(v, [[0,0],[1.0,19],[1.2,49],[1.4,80],[2.0,100]]),
  ebitda_margin: v => linScore(v, [[-5,0],[0,10],[8,40],[15,80],[25,100]]),
  // LTV: Verde<50%(80-100), Amarillo 50-60%(50-79), Naranja 60-70%(20-49), Rojo>70%(0-19)
  ltv:           v => v === null ? 55 : linScore(v, [[0,100],[50,80],[60,50],[70,20],[100,0]]),
  ffo_dfn:       v => linScore(v, [[0,10],[15,40],[20,80],[35,100]]),
  dias_cobro:    v => linScore(v, [[0,100],[45,80],[90,40],[180,0]]),
  equipo:        v => ({1:0,2:25,3:50,4:75,5:100})[Math.round(v)] || 0,
  concentracion: v => ({1:0,2:25,3:50,4:75,5:100})[Math.round(v)] || 0,
  antiguedad:    v => ({1:0,2:25,3:50,4:75,5:100})[Math.round(v)] || 0,
  ciclicidad:    v => ({1:0,2:25,3:50,4:75,5:100})[Math.round(v)] || 0,
};

// Sector benchmarks: {metric: {p25, med, p75}}
// metrics: em=EBITDA margin%, dn=DFN/EBITDA, ds=DSCR, dc=Días cobro
const SECT = {
  metalurgia:   { n:'Metalurgia / Fab. metal',    em:{p25:7,  med:11, p75:16}, dn:{p25:1.5,med:2.8,p75:4.2}, ds:{p25:1.0,med:1.4,p75:1.9}, dc:{p25:45, med:65, p75:90 } },
  quimica:      { n:'Química / Plásticos',         em:{p25:9,  med:14, p75:20}, dn:{p25:1.2,med:2.3,p75:3.8}, ds:{p25:1.1,med:1.5,p75:2.1}, dc:{p25:40, med:58, p75:80 } },
  alimentacion: { n:'Alimentación / Bebidas',      em:{p25:8,  med:12, p75:18}, dn:{p25:1.0,med:2.0,p75:3.5}, ds:{p25:1.2,med:1.6,p75:2.3}, dc:{p25:30, med:45, p75:65 } },
  automocion:   { n:'Automoción / Componentes',    em:{p25:6,  med:10, p75:15}, dn:{p25:1.8,med:3.0,p75:4.5}, ds:{p25:0.9,med:1.3,p75:1.8}, dc:{p25:50, med:72, p75:100} },
  papel_carton: { n:'Papel / Cartón',              em:{p25:10, med:15, p75:21}, dn:{p25:1.3,med:2.5,p75:4.0}, ds:{p25:1.1,med:1.5,p75:2.0}, dc:{p25:35, med:55, p75:75 } },
  construccion: { n:'Construcción industrial',     em:{p25:5,  med:9,  p75:14}, dn:{p25:2.0,med:3.2,p75:5.0}, ds:{p25:0.8,med:1.2,p75:1.7}, dc:{p25:60, med:85, p75:120} },
  energia:      { n:'Energía / Renovables',        em:{p25:30, med:45, p75:60}, dn:{p25:3.0,med:4.5,p75:6.5}, ds:{p25:1.3,med:1.7,p75:2.2}, dc:{p25:25, med:40, p75:60 } },
  logistica:    { n:'Logística / Transporte',      em:{p25:6,  med:10, p75:15}, dn:{p25:1.5,med:2.7,p75:4.2}, ds:{p25:1.0,med:1.4,p75:1.9}, dc:{p25:30, med:50, p75:70 } },
};

// ═══════════════════════════════════════════════════════════════
// RATIO CALCULATION
// ═══════════════════════════════════════════════════════════════
function calcRatios(d) {
  const ebitda   = d.ebitda;
  const ventas   = Math.max(d.ventas, 0.001);
  const dfn      = d.deuda_bruta - d.caja;
  const ebitda_margin = ebitda / ventas * 100;
  const deuda_ebitda  = ebitda > 0 ? dfn / ebitda : (dfn <= 0 ? -1 : 99);
  const dias_cobro    = d.clientes / ventas * 365;
  const dias_pago     = d.proveedores / ventas * 365;
  const liquidez      = d.pasivo_corriente > 0 ? d.activo_corriente / d.pasivo_corriente : 99;

  // CFADS = EBITDA - impuestos pagados - capex mantenimiento
  const cfads = ebitda - d.imp_pagado - (d.capex_mant || 0);

  // Debt service = gastos financieros + amortización (DFN / vida_media)
  const vida_media = Math.max(d.vida_media || 5, 0.5);
  const amort      = Math.max(dfn, 0) / vida_media;
  const debt_svc   = d.gastos_fin + amort;
  const dscr       = debt_svc > 0 ? cfads / debt_svc : (cfads > 0 ? 99 : 0);

  // LLCR: PV of CFADS over loan life / loan balance
  const loanBase = d.importe > 0 ? d.importe : Math.max(dfn, 0.001);
  const rate     = Math.max((d.tipo_int || 6) / 100, 0.0001);
  const n_loan   = d.importe > 0 ? Math.max(d.plazo || 5, 1) : Math.max(vida_media, 1);
  const pvFactor = (1 - Math.pow(1 + rate, -n_loan)) / rate;
  const llcr     = loanBase > 0 ? (cfads * pvFactor) / loanBase : 99;

  // LTV — use loanBase (importe or DFN) so colateral always feeds into scoring
  let ltv = null;
  if (d.colateral > 0) {
    ltv = (loanBase / d.colateral) * 100;
  }

  // FFO / DFN %
  const ffo     = ebitda - d.gastos_fin - d.imp_pagado;
  const ffo_dfn = dfn > 0 ? (ffo / dfn * 100) : (ffo > 0 ? 100 : 10);

  return {
    ebitda, ventas, dfn, ebitda_margin, deuda_ebitda,
    dias_cobro, dias_pago, liquidez, cfads, debt_svc,
    dscr, llcr, ltv, ffo, ffo_dfn, amort, vida_media, loanBase, n_loan, rate,
    tipo_col: d.tipo_col, colateral: d.colateral,
    importe: d.importe, plazo: d.plazo, tipo_int: d.tipo_int,
    gastos_fin: d.gastos_fin
  };
}

function calcScores(r) {
  const res = {};
  for (const [key, cfg] of Object.entries(PESOS)) {
    const val = r[key] !== undefined ? r[key] : null;
    const sc  = SCORE_FNS[key](val);
    const contrib = sc * cfg.peso / 100;
    const color   = sc >= 80 ? 'verde' : sc >= 50 ? 'amarillo' : sc >= 20 ? 'naranja' : 'rojo';
    res[key] = { valor: val, puntuacion: sc, peso: cfg.peso, contrib, color,
                 nombre: cfg.nombre, gating: cfg.gating };
  }
  return res;
}

function totalScore(res) {
  return Object.values(res).reduce((s, v) => s + v.contrib, 0);
}

function checkGating(res) {
  // DSCR < 1.0x → score 0-19 → auto-reject (principal gate)
  const dscrFails = res.dscr.puntuacion < 20;
  // DFN/EBITDA > 4.0x → score < 40 → secondary gate
  const dfnFails  = res.deuda_ebitda.puntuacion < 40;
  if (dscrFails && dfnFails) return 'DSCR < 1.0x y DFN/EBITDA > 4.0x simultáneamente: doble incumplimiento de métricas de exclusión. Operación rechazada automáticamente independientemente del score total.';
  if (dscrFails) return 'DSCR < 1.0x: el CFADS no cubre el servicio de la deuda. Umbral mínimo absoluto incumplido. Operación rechazada automáticamente.';
  if (dfnFails)  return 'DFN/EBITDA > 4.0x: nivel de apalancamiento fuera del umbral de mercado para deuda senior. Operación rechazada automáticamente.';
  return null;
}

// ═══════════════════════════════════════════════════════════════
// NUEVA DEUDA ANALYSIS
// ═══════════════════════════════════════════════════════════════
function calcNuevaDeuda(d, r) {
  if (d.importe <= 0) return null;
  const rate   = Math.max(d.tipo_int / 100, 0.0001);
  const n      = Math.max(d.plazo, 1);
  const newDS  = r.importe * rate + r.importe / n;           // simplified DS
  const combDS = r.debt_svc + newDS;
  const combDSCR = combDS > 0 ? r.cfads / combDS : 99;
  const fits     = combDSCR >= 1.25;

  // Max financeable at 1.25x DSCR
  const headroom  = r.cfads / 1.25 - r.debt_svc;
  const maxNew    = headroom > 0 ? Math.max(headroom / (rate + 1/n), 0) : 0;

  // LTV check
  const ltvMaxPct = LTV_MAX[d.tipo_col] || null;
  const ltvOk     = r.ltv !== null && ltvMaxPct !== null ? r.ltv <= ltvMaxPct : true;

  return { newDS, combDSCR, fits, maxNew, ltvOk, ltvMaxPct };
}

// ═══════════════════════════════════════════════════════════════
// READ INPUTS
// ═══════════════════════════════════════════════════════════════
function readInputs() {
  const g = id => parseFloat(document.getElementById(id).value) || 0;
  const gs = id => document.getElementById(id).value;
  // If inventory has data, use its total bruto as collateral (improves LTV scoring)
  const invTotal = _colRows.reduce((s,r) => s + (parseFloat(r.bruto)||0), 0);
  return {
    ventas: g('ventas'), ebitda: g('ebitda'), gastos_fin: g('gastos_fin'),
    imp_pagado: g('imp_pagado'), capex_mant: g('capex_mant'),
    deuda_bruta: g('deuda_bruta'), caja: g('caja'),
    activo_corriente: g('activo_corriente'), pasivo_corriente: g('pasivo_corriente'),
    clientes: g('clientes'), proveedores: g('proveedores'), vida_media: g('vida_media'),
    importe: g('importe'), plazo: g('plazo'), tipo_int: g('tipo_int'),
    colateral: invTotal > 0 ? invTotal : g('colateral'),
    tipo_col: gs('tipo_col'),
    equipo: parseInt(gs('equipo')), concentracion: parseInt(gs('concentracion')),
    antiguedad: parseInt(gs('antiguedad')), ciclicidad: parseInt(gs('ciclicidad')),
    sector_comp: gs('sector_comp'),
  };
}

// ═══════════════════════════════════════════════════════════════
// RENDER
// ═══════════════════════════════════════════════════════════════
let _currentData = null;

// ── Specific improvement text for ANALIZAR MÁS ──
function buildImprovementText(r, res) {
  // For each key metric, define: nextTarget if below verde, direction
  const checks = [
    {
      key: 'dscr', val: r.dscr, label: 'DSCR',
      thresholds: [{v:1.0,lbl:'1.0x (naranja)'},{v:1.2,lbl:'1.2x (amarillo)'},{v:1.5,lbl:'1.5x (verde)'}],
      fmt: v => v.toFixed(2)+'x', dir: 'higher'
    },
    {
      key: 'llcr', val: r.llcr, label: 'LLCR',
      thresholds: [{v:1.2,lbl:'1.2x (amarillo)'},{v:1.4,lbl:'1.4x (verde)'}],
      fmt: v => v.toFixed(2)+'x', dir: 'higher'
    },
    {
      key: 'deuda_ebitda', val: r.deuda_ebitda < 0 ? 0 : r.deuda_ebitda, label: 'DFN/EBITDA',
      thresholds: [{v:4.0,lbl:'4.0x'},{v:2.5,lbl:'2.5x (verde)'}],
      fmt: v => v.toFixed(2)+'x', dir: 'lower'
    },
    {
      key: 'ebitda_margin', val: r.ebitda_margin, label: 'Margen EBITDA',
      thresholds: [{v:8,lbl:'8%'},{v:15,lbl:'15% (verde)'}],
      fmt: v => v.toFixed(1)+'%', dir: 'higher'
    },
    {
      key: 'ffo_dfn', val: r.ffo_dfn, label: 'FFO/DFN',
      thresholds: [{v:15,lbl:'15%'},{v:20,lbl:'20% (verde)'}],
      fmt: v => v.toFixed(1)+'%', dir: 'higher'
    },
  ];

  const improvements = [];
  for (const c of checks) {
    if (res[c.key].puntuacion >= 80) continue; // ya verde, skip
    let target = null;
    if (c.dir === 'higher') {
      for (const t of c.thresholds) { if (c.val < t.v) { target = t; break; } }
    } else {
      for (const t of c.thresholds) { if (c.val > t.v) { target = t; break; } }
    }
    if (!target) continue;
    const pct = c.dir === 'higher'
      ? Math.abs((target.v - c.val) / Math.max(Math.abs(c.val), 0.001) * 100).toFixed(0)
      : Math.abs((c.val - target.v) / Math.max(Math.abs(target.v), 0.001) * 100).toFixed(0);
    const arrow = c.dir === 'higher' ? '↑' : '↓';
    improvements.push(`${c.label} actual ${c.fmt(c.val)} — necesita ${c.dir === 'higher' ? 'subir' : 'bajar'} a ${target.lbl} (${arrow}${pct}%)`);
    if (improvements.length >= 3) break;
  }

  return improvements.length > 0
    ? improvements.join('. ') + '.'
    : 'Revisar ratios de cobertura y apalancamiento.';
}

// ── Sidebar LTV indicator ──
function updateLtvIndicator() {
  const importe  = parseFloat(document.getElementById('importe').value) || 0;
  const colateral= parseFloat(document.getElementById('colateral').value) || 0;
  const tipocol  = document.getElementById('tipo_col').value;
  const ind      = document.getElementById('ltv-indicator');
  if (!ind) return;
  if (importe <= 0 || colateral <= 0 || tipocol === 'ninguno') {
    ind.className = 'ltv-indicator'; ind.textContent = ''; return;
  }
  const ltvCalc = (importe / colateral * 100).toFixed(1);
  const ltvMax  = LTV_MAX[tipocol];
  if (!ltvMax) { ind.className = 'ltv-indicator'; return; }
  const ok = parseFloat(ltvCalc) <= ltvMax;
  ind.className = 'ltv-indicator ' + (ok ? 'ltv-ok' : 'ltv-bad');
  ind.textContent = `LTV ${ltvCalc}% ${ok ? '✓' : '✗'} (máx. ${ltvMax}%)`;
}

function update() {
  const d = readInputs();
  const r = calcRatios(d);

  // Attach qualitative to ratios object for scoring
  r.equipo = d.equipo; r.concentracion = d.concentracion;
  r.antiguedad = d.antiguedad; r.ciclicidad = d.ciclicidad;

  const res   = calcScores(r);
  const score = Math.round(totalScore(res));
  const gate  = checkGating(res);
  const nd    = calcNuevaDeuda(d, r);

  _currentData = { d, r, res, score, gate, nd };

  renderScoring(d, r, res, score, gate);
  renderNuevaDeuda(d, r, nd);
  renderComparables(d, r);
  renderCovenants(r, res, score);
  renderDetalle(res, score);
  recalcColateral();
}

// ── SCORING TAB ──
function renderScoring(d, r, res, score, gate) {
  // KPIs
  setText('kpi-ebitda',  r.ebitda.toFixed(1) + ' M€');
  setText('kpi-margin',  r.ebitda_margin.toFixed(1) + '%');
  setText('kpi-dfn',     r.dfn.toFixed(1) + ' M€');
  setText('kpi-le',      (r.deuda_ebitda < 0 ? 'Caja neta' : r.deuda_ebitda.toFixed(2) + 'x'));
  setText('kpi-dscr',    r.dscr.toFixed(2) + 'x');
  setText('kpi-llcr',    r.llcr.toFixed(2) + 'x');

  // Gating banner
  const banner = document.getElementById('gating-banner');
  if (gate) {
    banner.classList.add('visible');
    setText('gating-text', gate);
  } else {
    banner.classList.remove('visible');
  }

  // Gauge
  const color = gate ? '#ef4444' : score >= 70 ? '#22c55e' : score >= 40 ? '#f59e0b' : '#ef4444';
  Plotly.react('gauge-chart', [{
    type: 'indicator', mode: 'gauge+number',
    value: score,
    gauge: {
      axis: { range:[0,100], tickfont:{size:10} },
      bar:  { color },
      steps: [
        { range:[0,40],  color:'#fee2e2' },
        { range:[40,70], color:'#fef3c7' },
        { range:[70,100],color:'#dcfce7' },
      ],
      threshold: { line:{color:'#0c2340',width:3}, thickness:.75, value: score }
    },
    number: { font:{size:36, color:'#0c2340'} }
  }], {
    margin:{t:10,b:10,l:30,r:30}, paper_bgcolor:'white', height:210
  }, { displayModeBar:false, responsive:true });

  // Stacked bar
  const labels = Object.values(res).map(v => v.nombre);
  const contribs = Object.values(res).map(v => +v.contrib.toFixed(2));
  const colors   = Object.values(res).map(v =>
    v.color === 'verde' ? '#22c55e' : v.color === 'amarillo' ? '#f59e0b' :
    v.color === 'naranja' ? '#f97316' : '#ef4444');
  Plotly.react('bar-chart', [{
    type:'bar', orientation:'h',
    x: contribs, y: labels,
    marker: { color: colors },
    text: contribs.map(v => v.toFixed(1)),
    textposition: 'outside',
    hovertemplate: '%{y}: %{x:.1f} pts<extra></extra>'
  }], {
    margin:{t:5,b:20,l:130,r:50},
    paper_bgcolor:'white', plot_bgcolor:'white',
    xaxis:{ range:[0, Math.max(...contribs)*1.35], showgrid:true, gridcolor:'#f1f5f9' },
    yaxis:{ automargin:true, tickfont:{size:11} },
    height:210
  }, { displayModeBar:false, responsive:true });

  // Recommendation
  const recBanner = document.getElementById('rec-banner');
  recBanner.className = 'rec-banner ';
  let icon, decision, text;
  if (gate) {
    recBanner.className += 'rojo';
    icon = '⛔'; decision = 'RECHAZAR';
    text = 'La operación incumple una métrica de exclusión (gating). Independientemente del score total, la política de riesgo impide la aprobación. Requiere reestructuración financiera previa o garantías adicionales extraordinarias.';
  } else if (score >= 70) {
    recBanner.className += 'verde';
    icon = '✅'; decision = 'OPERAR';
    text = `Score ${score}/100 — Perfil de riesgo sólido. Se recomienda avanzar con la operación bajo condiciones estándar. Establecer covenants de seguimiento trimestral. Posible pricing competitivo por encima de DSCR ${r.dscr.toFixed(2)}x.`;
  } else if (score >= 40) {
    recBanner.className += 'amarillo';
    icon = '⚠️'; decision = 'ANALIZAR MÁS';
    text = `Score ${score}/100 — Perfil de riesgo moderado con alertas. ${buildImprovementText(r, res)} Ampliar due diligence y exigir covenants reforzados.`;
  } else {
    recBanner.className += 'rojo';
    icon = '❌'; decision = 'RECHAZAR';
    text = `Score ${score}/100 — Perfil de riesgo elevado. Los ratios de cobertura y/o apalancamiento no alcanzan umbrales mínimos de mercado. Rechazar en las condiciones actuales. Posible revisión si el cliente presenta plan de mejora creíble con sponsor financiero.`;
  }
  setText('rec-icon', icon);
  setText('rec-decision', decision);
  setText('rec-text', text);

  // Ratio tiles
  const fmtMap = {
    dscr:          { fmt: v => v.toFixed(2)+'x', label:'DSCR' },
    deuda_ebitda:  { fmt: v => v < 0 ? 'Caja neta' : v.toFixed(2)+'x', label:'DFN / EBITDA' },
    llcr:          { fmt: v => v.toFixed(2)+'x', label:'LLCR' },
    ebitda_margin: { fmt: v => v.toFixed(1)+'%', label:'Margen EBITDA' },
    ltv:           { fmt: v => v === null ? 'N/A' : v.toFixed(1)+'%', label:'LTV Colateral' },
    ffo_dfn:       { fmt: v => v.toFixed(1)+'%', label:'FFO / DFN' },
    dias_cobro:    { fmt: v => Math.round(v)+' días', label:'Días Cobro' },
    equipo:        { fmt: v => v+' / 5', label:'Equipo' },
    concentracion: { fmt: v => v+' / 5', label:'Diversif. Clientes' },
    antiguedad:    { fmt: v => v+' / 5', label:'Antigüedad' },
    ciclicidad:    { fmt: v => v+' / 5', label:'Estabilidad' },
  };
  const subMap = {
    dscr:'cobertura deuda', deuda_ebitda:'apalancamiento', llcr:'loan life coverage',
    ebitda_margin:'sobre ventas', ltv:'loan-to-value', ffo_dfn:'sobre DFN',
    dias_cobro:'DSO cobro', equipo:'cualitativo', concentracion:'cualitativo',
    antiguedad:'cualitativo', ciclicidad:'cualitativo',
  };
  let tilesHtml = '';
  for (const [key, m] of Object.entries(fmtMap)) {
    const rv = res[key];
    const gBadge = rv.gating ? '<span class="gating-badge">GATE</span>' : '';
    const valStr = fmtMap[key].fmt(rv.valor);
    tilesHtml += `
      <div class="ratio-tile ${rv.color}">
        <div class="rt-label">${m.label}${gBadge}</div>
        <div class="rt-value">${valStr}</div>
        <div class="rt-sub">${subMap[key]}</div>
        <span class="rt-score">${rv.puntuacion} pts × ${rv.peso}%</span>
      </div>`;
  }
  document.getElementById('ratio-grid').innerHTML = tilesHtml;

  // Radar
  const names = Object.values(res).map(v => v.nombre);
  const scores = Object.values(res).map(v => v.puntuacion);
  Plotly.react('radar-chart', [{
    type:'scatterpolar', mode:'lines+markers',
    r: [...scores, scores[0]], theta: [...names, names[0]],
    fill:'toself', fillcolor:'rgba(29,78,216,0.12)',
    line:{ color:'#1d4ed8', width:2 },
    marker:{ color:'#1d4ed8', size:6 }
  }], {
    polar:{ radialaxis:{range:[0,100],tickfont:{size:9}}, bgcolor:'white' },
    paper_bgcolor:'white', margin:{t:20,b:20,l:50,r:50}, height:300
  }, { displayModeBar:false, responsive:true });

  // Top 3 risks
  const sorted = Object.entries(res)
    .map(([k,v]) => ({ ...v, key:k, perdida: v.peso - v.contrib }))
    .sort((a,b) => b.perdida - a.perdida)
    .slice(0, 3);

  const riskHtml = sorted.map((f, i) => {
    const valStr = fmtMap[f.key] ? fmtMap[f.key].fmt(f.valor) : f.valor;
    return `
      <div class="risk-card">
        <div class="r-rank">#${i+1} Factor de Riesgo</div>
        <div class="r-name">${f.nombre}${f.gating ? ' <span class="gating-badge">GATE</span>' : ''}</div>
        <div class="r-value">Valor: ${valStr} — Score: ${f.puntuacion}/100</div>
        <div class="r-impact">Impacto: −${f.perdida.toFixed(1)} pts de contribución potencial</div>
      </div>`;
  }).join('');
  document.getElementById('risk-grid').innerHTML = riskHtml;
}

// ── NUEVA DEUDA TAB ──
function renderNuevaDeuda(d, r, nd) {
  const ndC   = document.getElementById('nd-content');
  const ndCap = document.getElementById('nd-capacity');
  const ndLtv = document.getElementById('nd-ltv');

  // ── Capacidad de endeudamiento — siempre visible ──
  const rate_cap = Math.max((d.tipo_int || 6) / 100, 0.0001);
  const n_cap    = Math.max(d.plazo || 5, 1);
  const maxNew   = r.cfads / 1.25 > r.debt_svc
    ? Math.max((r.cfads / 1.25 - r.debt_svc) / (rate_cap + 1/n_cap), 0)
    : 0;
  const headroomPct = r.debt_svc > 0
    ? ((r.cfads / r.debt_svc - 1.25) / 1.25 * 100).toFixed(1)
    : '∞';

  ndCap.innerHTML = `
    <div class="nd-row"><span class="nd-lbl">CFADS disponible</span><span class="nd-val">${r.cfads.toFixed(2)} M€</span></div>
    <div class="nd-row"><span class="nd-lbl">Servicio deuda actual / año</span><span class="nd-val">${r.debt_svc.toFixed(2)} M€</span></div>
    <div class="nd-row"><span class="nd-lbl">DSCR actual</span><span class="nd-val">${r.dscr.toFixed(2)}x</span></div>
    <div class="nd-row"><span class="nd-lbl">Importe máx. financiable (DSCR = 1.25x)</span>
      <span class="nd-val" style="color:${maxNew > 0 ? '#15803d' : '#991b1b'};font-size:1rem;">
        ${maxNew > 0 ? maxNew.toFixed(2)+' M€' : 'Capacidad agotada'}
      </span>
    </div>
    <div class="nd-row"><span class="nd-lbl">Headroom sobre 1.25x DSCR</span><span class="nd-val">${headroomPct}%</span></div>
    <div class="nd-row"><span class="nd-lbl">Tipo int. referencia / Plazo</span><span class="nd-val">${d.tipo_int}% / ${d.plazo} años</span></div>`;

  // ── Análisis de operación nueva — sólo si importe > 0 ──
  if (!nd) {
    ndC.innerHTML = `
      <p style="color:#94a3b8;font-size:.85rem;margin-bottom:.8rem;">
        Introduce el importe, plazo y tipo de interés en el panel lateral para analizar la operación concreta.
      </p>
      <div class="nd-row"><span class="nd-lbl">Capacidad adicional estimada</span>
        <span class="nd-val" style="color:${maxNew>0?'#15803d':'#991b1b'};">
          ${maxNew > 0 ? '≈ '+maxNew.toFixed(2)+' M€ disponibles' : 'Sin capacidad adicional'}
        </span>
      </div>`;
  } else {
    const statusClass = nd.fits ? 'nd-ok' : nd.combDSCR >= 1.0 ? 'nd-warn' : 'nd-bad';
    const statusText  = nd.fits ? '✓ VIABLE (DSCR ≥ 1.25x)' : nd.combDSCR >= 1.0 ? '⚠ AJUSTADO (1.0x–1.25x)' : '✗ NO VIABLE (DSCR < 1.0x)';
    const margin      = maxNew - d.importe;
    ndC.innerHTML = `
      <div class="nd-row"><span class="nd-lbl">Importe solicitado</span><span class="nd-val">${d.importe.toFixed(2)} M€</span></div>
      <div class="nd-row"><span class="nd-lbl">Servicio deuda nueva / año</span><span class="nd-val">${nd.newDS.toFixed(2)} M€</span></div>
      <div class="nd-row"><span class="nd-lbl">DSCR combinado (nueva + existente)</span><span class="nd-val">${nd.combDSCR.toFixed(2)}x</span></div>
      <div class="nd-row"><span class="nd-lbl">Margen vs. importe máx. financiable</span>
        <span class="nd-val" style="color:${margin>=0?'#15803d':'#991b1b'};">
          ${margin >= 0 ? '+'+margin.toFixed(2)+' M€' : margin.toFixed(2)+' M€'}
        </span>
      </div>
      <div class="nd-row"><span class="nd-lbl">Resultado</span>
        <span class="nd-val"><span class="nd-status ${statusClass}">${statusText}</span></span>
      </div>`;
  }

  // ── LTV ──
  if (d.colateral > 0 && d.importe > 0 && r.ltv !== null) {
    const ltvMax    = LTV_MAX[d.tipo_col] || null;
    const ltvStatus = ltvMax ? (r.ltv <= ltvMax ? 'nd-ok' : 'nd-bad') : 'nd-warn';
    const ltvTxt    = ltvMax
      ? (r.ltv <= ltvMax ? `✓ Dentro del límite (máx. ${ltvMax}%)` : `✗ Supera límite ${ltvMax}% para ${d.tipo_col}`)
      : 'Sin límite definido';
    ndLtv.innerHTML = `
      <div class="nd-row"><span class="nd-lbl">Tipo de colateral</span><span class="nd-val">${d.tipo_col}</span></div>
      <div class="nd-row"><span class="nd-lbl">Valor colateral</span><span class="nd-val">${d.colateral.toFixed(2)} M€</span></div>
      <div class="nd-row"><span class="nd-lbl">Importe solicitado</span><span class="nd-val">${d.importe.toFixed(2)} M€</span></div>
      <div class="nd-row"><span class="nd-lbl">LTV calculado</span><span class="nd-val">${r.ltv.toFixed(1)}%</span></div>
      <div class="nd-row"><span class="nd-lbl">Resultado LTV</span>
        <span class="nd-val"><span class="nd-status ${ltvStatus}">${ltvTxt}</span></span>
      </div>`;
  } else {
    ndLtv.innerHTML = '<p style="color:#94a3b8;font-size:.85rem;">Introduce importe y valor del colateral para ver el análisis LTV.</p>';
  }
}

// ── COMPARABLES TAB ──
function renderComparables(d, r) {
  const sect = SECT[d.sector_comp] || SECT['metalurgia'];
  setText('sect-name', sect.n);

  const metrics = [
    { key:'em',  label:'Margen EBITDA (%)', val: r.ebitda_margin, fmt: v => v.toFixed(1)+'%', higher:'better' },
    { key:'dn',  label:'DFN / EBITDA (x)',  val: r.deuda_ebitda < 0 ? 0 : r.deuda_ebitda, fmt: v => v.toFixed(2)+'x', higher:'worse' },
    { key:'ds',  label:'DSCR (x)',           val: r.dscr, fmt: v => v.toFixed(2)+'x', higher:'better' },
    { key:'dc',  label:'Días Cobro',         val: r.dias_cobro, fmt: v => Math.round(v)+' d', higher:'worse' },
  ];

  let rows = '';
  metrics.forEach(m => {
    const s = sect[m.key];
    const v = m.val;
    // Position
    let pos, posCls;
    if (m.higher === 'better') {
      if (v >= s.p75)      { pos='Top 25%'; posCls='pos-good'; }
      else if (v >= s.med) { pos='25–50%';  posCls='pos-mid';  }
      else if (v >= s.p25) { pos='50–75%';  posCls='pos-mid';  }
      else                 { pos='Bottom 25%'; posCls='pos-bad'; }
    } else {
      if (v <= s.p25)      { pos='Top 25%'; posCls='pos-good'; }
      else if (v <= s.med) { pos='25–50%';  posCls='pos-mid';  }
      else if (v <= s.p75) { pos='50–75%';  posCls='pos-mid';  }
      else                 { pos='Bottom 25%'; posCls='pos-bad'; }
    }
    rows += `<tr class="company-row">
      <td>${m.label}</td>
      <td>${m.fmt(s.p25)}</td>
      <td>${m.fmt(s.med)}</td>
      <td>${m.fmt(s.p75)}</td>
      <td style="font-weight:800;">${m.fmt(v)}</td>
      <td class="${posCls}">${pos}</td>
    </tr>`;
  });
  document.getElementById('sect-tbody').innerHTML = rows;

  // Waterfall chart comparing metrics
  const categories = metrics.map(m => m.label);
  const companyVals = metrics.map(m => m.val);
  const medVals     = metrics.map(m => sect[m.key].med);

  Plotly.react('sect-chart', [
    {
      type:'bar', name:'Esta empresa',
      x: categories, y: companyVals,
      marker:{ color:'#1d4ed8' },
      text: companyVals.map((v,i) => metrics[i].fmt(v)),
      textposition:'outside'
    },
    {
      type:'bar', name:'Mediana sector',
      x: categories, y: medVals,
      marker:{ color:'#94a3b8' },
      text: medVals.map((v,i) => metrics[i].fmt(v)),
      textposition:'outside'
    }
  ], {
    barmode:'group',
    paper_bgcolor:'white', plot_bgcolor:'white',
    legend:{ orientation:'h', y:1.15 },
    margin:{ t:30,b:40,l:40,r:20 },
    height:280,
    yaxis:{ showgrid:true, gridcolor:'#f1f5f9' }
  }, { displayModeBar:false, responsive:true });
}

// ── COVENANTS TAB ──
function renderCovenants(r, res, score) {
  // Covenant values
  const dnCov   = Math.min(+(r.deuda_ebitda < 0 ? 2.0 : r.deuda_ebitda * 1.35 + 0.5).toFixed(2), 5.0);
  const dscrCov = Math.max(+(r.dscr * 0.82).toFixed(2), 1.10);
  const capexCov = +((r.ebitda * 0.25)).toFixed(1);

  const covCards = [
    { name:'DFN / EBITDA máximo', value: `≤ ${dnCov}x`, desc:'Límite de apalancamiento con headroom vs. ratio actual. Revisión semestral.' },
    { name:'DSCR mínimo', value: `≥ ${dscrCov}x`, desc:'Cobertura de deuda mínima con colchón del 18%. Cálculo sobre los últimos 12 meses.' },
    { name:'Capex máximo anual', value: `≤ ${capexCov} M€`, desc:'Cap equivalente al 25% del EBITDA. Excepciones previa aprobación del banco.' },
    { name:'Restricción dividendos', value: score >= 70 ? 'Max 40% NOPAT' : 'Suspensión total', desc: score >= 70 ? 'Distribución permitida si score > 70 y DFN/EBITDA < techo.' : 'Sin distribuciones mientras score < 70 o covenant en breach.' },
  ];

  document.getElementById('cov-grid').innerHTML = covCards.map(c => `
    <div class="cov-card">
      <div class="cov-name">${c.name}</div>
      <div class="cov-value">${c.value}</div>
      <div class="cov-desc">${c.desc}</div>
    </div>`).join('');

  // Pricing
  const tranches = [
    { label:'Tramo Senior A', spread: score >= 80 ? '175–275 bps' : score >= 70 ? '275–375 bps' : score >= 55 ? '375–500 bps' : 'N/A (no viable)', active: score >= 55 },
    { label:'Tramo Senior B', spread: score >= 70 ? '375–500 bps' : score >= 55 ? '500–650 bps' : 'N/A', active: score >= 55 },
    { label:'Tramo Subordinado', spread: score >= 70 ? '600–900 bps' : 'N/A (score insuficiente)', active: score >= 70 },
    { label:'Euribor base', spread: 'Euribor 3M/6M vigente', active: true },
  ];

  document.getElementById('pricing-grid').innerHTML = tranches.map(t => `
    <div class="pricing-card ${t.active ? 'active-price' : ''}">
      <div class="pc-tranche">${t.label}</div>
      <div class="pc-spread">${t.spread}</div>
      <div class="pc-note">${t.active ? 'Aplicable' : 'No aplicable'}</div>
    </div>`).join('');

  document.getElementById('pricing-note').textContent =
    `Pricing basado en score ${score}/100. Spreads orientativos sobre Euribor. Ajustar según rating interno final, colateral y estructura de la operación.`;

  // Extra conditions
  const extras = [];
  if (r.dscr < 1.5) extras.push('Amortización acelerada: al menos 15% anual del principal pendiente.');
  if (r.deuda_ebitda > 3.0) extras.push('Obligación de desinversión de activos no estratégicos si DFN/EBITDA > techo en 2 semestres consecutivos.');
  if (r.dias_cobro > 90) extras.push('Plan de mejora de capital circulante con revisión trimestral de factoring o confirming.');
  if (res.equipo.puntuacion < 50) extras.push('Nombramiento de CFO independiente o Chief Restructuring Officer como condición previa al desembolso.');
  if (extras.length === 0) extras.push('Sin condiciones adicionales fuera de los covenants estándar. Operación calificada en línea con política de riesgo.');
  extras.push('Reporting financiero trimestral con certificación de cumplimiento de covenants.');
  extras.push('Seguro de crédito sobre la cartera de clientes recomendado si concentración top-3 > 50%.');

  document.getElementById('cov-extra').innerHTML = extras.map(e =>
    `<div style="display:flex;gap:.7rem;align-items:flex-start;padding:.55rem 0;border-bottom:1px solid #f1f5f9;">
      <span style="color:#1d4ed8;font-weight:800;flex-shrink:0;">→</span>
      <span style="font-size:.85rem;color:#374151;line-height:1.5;">${e}</span>
    </div>`).join('');
}

// ── DETALLE TAB ──
function renderDetalle(res, score) {
  const fmtValMap = {
    dscr:          v => v.toFixed(2)+'x',
    deuda_ebitda:  v => v < 0 ? 'Caja neta' : v.toFixed(2)+'x',
    llcr:          v => v.toFixed(2)+'x',
    ebitda_margin: v => v.toFixed(1)+'%',
    ltv:           v => v === null ? 'N/A' : v.toFixed(1)+'%',
    ffo_dfn:       v => v.toFixed(1)+'%',
    dias_cobro:    v => Math.round(v)+' días',
    equipo:        v => v+' / 5',
    concentracion: v => v+' / 5',
    antiguedad:    v => v+' / 5',
    ciclicidad:    v => v+' / 5',
  };

  let rows = '';
  for (const [key, rv] of Object.entries(res)) {
    const valStr = fmtValMap[key] ? fmtValMap[key](rv.valor) : rv.valor;
    const badge  = rv.color === 'verde'   ? `<span class="badge-v">VERDE</span>` :
                   rv.color === 'amarillo' ? `<span class="badge-a">AMARILLO</span>` :
                   rv.color === 'naranja'  ? `<span class="badge-n">NARANJA</span>` :
                   `<span class="badge-r">ROJO</span>`;
    const gateBadge = rv.gating ? `<span class="badge-g">GATE</span> ` : '';
    rows += `<tr>
      <td>${gateBadge}${rv.nombre}</td>
      <td>${valStr}</td>
      <td><div style="display:flex;align-items:center;gap:.5rem;">
        <div style="flex:1;background:#f1f5f9;border-radius:10px;height:6px;">
          <div style="width:${rv.puntuacion}%;background:${rv.color==='verde'?'#22c55e':rv.color==='amarillo'?'#f59e0b':'#ef4444'};height:6px;border-radius:10px;"></div>
        </div>
        <span style="font-weight:700;font-size:.85rem;">${rv.puntuacion}</span>
      </div></td>
      <td>${rv.peso}%</td>
      <td style="font-weight:700;">${rv.contrib.toFixed(2)}</td>
      <td>${badge}</td>
    </tr>`;
  }
  document.getElementById('det-tbody').innerHTML = rows;

  const finalScore = Math.round(score);
  const finalColor = finalScore >= 70 ? '#22c55e' : finalScore >= 40 ? '#f59e0b' : '#ef4444';
  setText('det-total', `<span style="font-size:1.1rem;color:${finalColor};">${finalScore} / 100</span>`);
  const semC = finalScore >= 70 ? 'badge-v' : finalScore >= 40 ? 'badge-a' : 'badge-r';
  const semT = finalScore >= 70 ? 'VERDE'   : finalScore >= 40 ? 'AMARILLO' : 'ROJO';
  document.getElementById('det-semaforo').innerHTML = `<span class="${semC}">${semT}</span>`;
}

// ═══════════════════════════════════════════════════════════════
// EXAMPLES
// ═══════════════════════════════════════════════════════════════
const EXAMPLES = {
  tubacex: {
    ventas:767.5, ebitda:107, gastos_fin:14.5, imp_pagado:5, capex_mant:20,
    deuda_bruta:420, caja:165, activo_corriente:480, pasivo_corriente:378,
    clientes:76, proveedores:473, vida_media:4,
    importe:0, plazo:5, tipo_int:6, colateral:0, tipo_col:'inmueble',
    equipo:'4', concentracion:'3', antiguedad:'5', ciclicidad:'2',
    sector_comp:'metalurgia',
    colRows: [
      { tipo:'nave',          desc:'Naves industriales Amurrio/Llodio', bruto:180 },
      { tipo:'maquinaria',    desc:'Líneas de producción tubos sin costura', bruto:95 },
      { tipo:'cuentas_cobrar',desc:'Cartera clientes Oil & Gas', bruto:120 },
    ]
  },
  aa: {
    ventas:200, ebitda:46, gastos_fin:3, imp_pagado:5, capex_mant:3,
    deuda_bruta:40, caja:22, activo_corriente:90, pasivo_corriente:45,
    clientes:35, proveedores:30, vida_media:6,
    importe:0, plazo:5, tipo_int:5, colateral:0, tipo_col:'inmueble',
    equipo:'5', concentracion:'4', antiguedad:'5', ciclicidad:'4',
    sector_comp:'quimica'
  },
  c: {
    ventas:80, ebitda:5, gastos_fin:6, imp_pagado:0.5, capex_mant:1.5,
    deuda_bruta:65, caja:4, activo_corriente:35, pasivo_corriente:38,
    clientes:30, proveedores:20, vida_media:3,
    importe:0, plazo:5, tipo_int:9, colateral:0, tipo_col:'maquinaria',
    equipo:'2', concentracion:'2', antiguedad:'2', ciclicidad:'2',
    sector_comp:'construccion'
  }
};

function loadExample(name) {
  const ex = EXAMPLES[name];
  if (!ex) return;
  const fields = ['ventas','ebitda','gastos_fin','imp_pagado','capex_mant',
    'deuda_bruta','caja','activo_corriente','pasivo_corriente','clientes',
    'proveedores','vida_media','importe','plazo','tipo_int','colateral'];
  fields.forEach(f => {
    const el = document.getElementById(f);
    if (el) el.value = ex[f];
  });
  ['tipo_col','equipo','concentracion','antiguedad','ciclicidad','sector_comp'].forEach(f => {
    const el = document.getElementById(f);
    if (el) el.value = ex[f];
  });
  // Load colateral inventory rows if defined
  _colRows = (ex.colRows || []).map(r => ({ tipo: r.tipo, desc: r.desc, bruto: r.bruto }));
  renderColTable();
  update();
}

function resetForm() {
  ['ventas','ebitda','gastos_fin','imp_pagado','capex_mant',
   'deuda_bruta','caja','activo_corriente','pasivo_corriente',
   'clientes','proveedores'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('vida_media').value = 5;
  document.getElementById('importe').value = 0;
  document.getElementById('plazo').value = 5;
  document.getElementById('tipo_int').value = 6;
  document.getElementById('colateral').value = 0;
  document.getElementById('tipo_col').value = 'inmueble';
  document.getElementById('equipo').value = 3;
  document.getElementById('concentracion').value = 3;
  document.getElementById('antiguedad').value = 3;
  document.getElementById('ciclicidad').value = 3;
  document.getElementById('sector_comp').value = 'metalurgia';
  // Clear charts
  ['gauge-chart','bar-chart','radar-chart','sect-chart'].forEach(id => {
    const el = document.getElementById(id);
    if (el) Plotly.purge(id);
  });
  document.getElementById('ratio-grid').innerHTML = '';
  document.getElementById('risk-grid').innerHTML = '';
  document.getElementById('gating-banner').classList.remove('visible');
  document.getElementById('nd-content').innerHTML = '<p style="color:#94a3b8;font-size:.85rem;">Introduzca datos para ver el análisis.</p>';
  document.getElementById('nd-capacity').innerHTML = '';
  document.getElementById('nd-ltv').innerHTML = '';
  document.getElementById('sect-tbody').innerHTML = '';
  document.getElementById('cov-grid').innerHTML = '';
  document.getElementById('pricing-grid').innerHTML = '';
  document.getElementById('cov-extra').innerHTML = '';
  document.getElementById('det-tbody').innerHTML = '';
  // Reset colateral inventory
  _colRows = [];
  renderColTable();
  ['col-s2','col-s3','col-s4'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  if (document.getElementById('col-waterfall')) Plotly.purge('col-waterfall');
}

// ═══════════════════════════════════════════════════════════════
// TABS
// ═══════════════════════════════════════════════════════════════
const TAB_IDS = ['scoring','nueva_deuda','comparables','covenants','colateral','detalle'];

function switchTab(name) {
  TAB_IDS.forEach(t => {
    document.getElementById('tab-'+t).classList.toggle('active', t === name);
  });
  document.querySelectorAll('.tab').forEach((el, i) => {
    el.className = 'tab ' + (TAB_IDS[i] === name ? 'active' : 'inactive');
  });
}

// ═══════════════════════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════════════════════
function setText(id, html) {
  const el = document.getElementById(id);
  if (el) el.innerHTML = html;
}

// ═══════════════════════════════════════════════════════════════
// COLATERAL ANALYSIS
// ═══════════════════════════════════════════════════════════════

const COL_CFG = {
  inmueble:       { label:'Inmueble comercial', haircut:0.40, execMid:3.0,    execLabel:'24–48 meses' },
  nave:           { label:'Nave industrial',    haircut:0.40, execMid:3.0,    execLabel:'24–48 meses' },
  maquinaria:     { label:'Maquinaria',         haircut:0.60, execMid:0.75,   execLabel:'6–12 meses'  },
  stock:          { label:'Stock / Inventario', haircut:0.50, execMid:0.167,  execLabel:'1–3 meses'   },
  cuentas_cobrar: { label:'Cuentas a cobrar',   haircut:0.30, execMid:0.375,  execLabel:'3–6 meses'   },
  otros:          { label:'Otros',              haircut:0.50, execMid:0.75,   execLabel:'6–12 meses'  },
};

let _colRows = [];

function addColRow() {
  _colRows.push({ tipo:'inmueble', desc:'', bruto:0 });
  renderColTable();
  update();
}

function removeColRow(i) {
  _colRows.splice(i, 1);
  renderColTable();
  update();
}

function onColChange(i, field, val) {
  _colRows[i][field] = field === 'bruto' ? (parseFloat(val) || 0) : val;
  if (field !== 'desc') { renderColTable(); update(); }
}

function renderColTable() {
  const tbody = document.getElementById('col-tbody');
  const tfoot = document.getElementById('col-tfoot');
  if (!tbody) return;

  if (_colRows.length === 0) {
    tbody.innerHTML = '<tr id="col-empty"><td colspan="7" style="text-align:center;color:#94a3b8;padding:1.8rem;font-size:.85rem;">Sin activos. Pulsa "+ Añadir activo" para comenzar.</td></tr>';
    tfoot.style.display = 'none';
    return;
  }
  tfoot.style.display = '';

  let totalBruto = 0, totalNeto = 0;
  const opts = key => Object.entries(COL_CFG).map(([k,v]) =>
    `<option value="${k}" ${k===key?'selected':''}>${v.label}</option>`).join('');

  tbody.innerHTML = _colRows.map((row, i) => {
    const cfg  = COL_CFG[row.tipo] || COL_CFG.otros;
    const neto = (row.bruto||0) * (1 - cfg.haircut);
    totalBruto += row.bruto||0;
    totalNeto  += neto;
    return `<tr>
      <td><select onchange="onColChange(${i},'tipo',this.value)" class="col-inp col-sel">${opts(row.tipo)}</select></td>
      <td><input type="text" value="${row.desc||''}" onchange="onColChange(${i},'desc',this.value)" placeholder="Descripción..." class="col-inp col-inp-desc"></td>
      <td style="text-align:right;"><input type="number" value="${row.bruto||''}" step="0.1" min="0" oninput="onColChange(${i},'bruto',this.value)" class="col-inp col-inp-num"></td>
      <td class="col-haircut">${Math.round(cfg.haircut*100)}%</td>
      <td class="col-neto">${neto.toFixed(2)}</td>
      <td style="font-size:.75rem;color:#64748b;white-space:nowrap;">${cfg.execLabel}</td>
      <td style="text-align:center;"><button class="col-del-btn" onclick="removeColRow(${i})">×</button></td>
    </tr>`;
  }).join('');

  document.getElementById('col-t-bruto').textContent = totalBruto.toFixed(2);
  document.getElementById('col-t-neto').textContent  = totalNeto.toFixed(2);
}

function recalcColateral() {
  const s2 = document.getElementById('col-s2');
  const s3 = document.getElementById('col-s3');
  const s4 = document.getElementById('col-s4');
  if (!s2) return;

  if (_colRows.length === 0 || !_currentData) {
    s2.style.display = s3.style.display = s4.style.display = 'none';
    return;
  }

  const { d, score } = _currentData;

  // Compute per-row enriched values
  const rows = _colRows.map(row => {
    const cfg  = COL_CFG[row.tipo] || COL_CFG.otros;
    const neto = (row.bruto||0) * (1 - cfg.haircut);
    const pv   = neto / Math.pow(1.08, cfg.execMid);
    return { ...row, ...cfg, neto, pv };
  });

  const totalBruto = rows.reduce((s,r) => s + (r.bruto||0), 0);
  const totalNeto  = rows.reduce((s,r) => s + r.neto, 0);
  const totalPV    = rows.reduce((s,r) => s + r.pv, 0);

  const importe = d.importe > 0 ? d.importe : Math.max(_currentData.r.dfn, 0.001);
  const ltv       = totalBruto > 0 ? (importe / totalBruto * 100) : null;
  const recRate   = importe > 0 ? Math.min(totalPV / importe * 100, 200) : 0;
  const lgd       = Math.max(1 - recRate/100, 0);
  const ead       = importe;
  const pd        = score > 70 ? 0.015 : score >= 50 ? 0.035 : 0.07;
  const rwa       = ead * pd * lgd * 1.2 * 12.5;
  const expLoss   = ead * pd * lgd;

  s2.style.display = s3.style.display = s4.style.display = '';

  // ── KPI cards ──
  const kpiCfg = [
    { label:'LTV',              val: ltv !== null ? ltv.toFixed(1)+'%' : 'N/A',
      sub:'Deuda / Colateral bruto',
      cls: ltv === null ? 'rb' : ltv < 50 ? 'rv' : ltv < 60 ? 'ra' : ltv < 70 ? 'rn' : 'rr' },
    { label:'Recovery Rate',    val: recRate.toFixed(1)+'%',
      sub:'Valor neto PV / Deuda',
      cls: recRate >= 70 ? 'rv' : recRate >= 40 ? 'ra' : 'rr' },
    { label:'LGD',              val: (lgd*100).toFixed(1)+'%',
      sub:'Loss Given Default',
      cls: lgd < 0.30 ? 'rv' : lgd < 0.60 ? 'ra' : 'rr' },
    { label:'EAD',              val: ead.toFixed(2)+' M€',
      sub:'Exposure at Default', cls:'rb' },
    { label:'PD estimada',      val: (pd*100).toFixed(2)+'%',
      sub:'Basada en score '+score,
      cls: pd <= 0.015 ? 'rv' : pd <= 0.035 ? 'ra' : 'rr' },
    { label:'Pérdida esperada', val: expLoss.toFixed(3)+' M€',
      sub:'EAD × PD × LGD',
      cls: expLoss/ead < 0.01 ? 'rv' : expLoss/ead < 0.05 ? 'ra' : 'rr' },
    { label:'RWA estimado',     val: rwa.toFixed(2)+' M€',
      sub:'EAD × PD × LGD × 15', cls:'rb' },
    { label:'Recovery PV total',val: totalPV.toFixed(2)+' M€',
      sub:'Descontado al 8%',
      cls: totalPV >= ead ? 'rv' : totalPV >= ead*0.6 ? 'ra' : 'rr' },
    { label:'Colateral bruto',  val: totalBruto.toFixed(2)+' M€',
      sub:'Total inventario', cls:'rb' },
    { label:'Colateral neto',   val: totalNeto.toFixed(2)+' M€',
      sub:'Tras haircuts', cls:'rb' },
  ];
  document.getElementById('col-kpis').innerHTML = kpiCfg.map(k =>
    `<div class="rec-kpi ${k.cls}">
       <div class="rk-label">${k.label}</div>
       <div class="rk-value">${k.val}</div>
       <div class="rk-sub">${k.sub}</div>
     </div>`).join('');

  // ── Waterfall chart ──
  const perdida = Math.max(importe - totalPV, 0);
  Plotly.react('col-waterfall', [
    { type:'bar', name:'Deuda prestada',       x:['Deuda prestada'],       y:[importe],
      marker:{color:'#1d4ed8'}, text:[importe.toFixed(2)+' M€'], textposition:'outside' },
    { type:'bar', name:'Recovery esperado (PV)',x:['Recovery esperado (PV)'],y:[totalPV],
      marker:{color:'#22c55e'}, text:[totalPV.toFixed(2)+' M€ ('+recRate.toFixed(0)+'%)'], textposition:'outside' },
    { type:'bar', name:'Pérdida esperada (EL)', x:['Pérdida esperada (EL)'],y:[expLoss],
      marker:{color:'#ef4444'}, text:[expLoss.toFixed(3)+' M€'], textposition:'outside' },
  ], {
    barmode:'group', paper_bgcolor:'white', plot_bgcolor:'white',
    legend:{ orientation:'h', y:1.2 },
    yaxis:{ title:'M€', gridcolor:'#f1f5f9', showgrid:true },
    margin:{ t:40,b:40,l:60,r:20 }, height:300,
  }, { displayModeBar:false, responsive:true });

  // ── Priority table ──
  const sorted = [...rows].sort((a,b) => a.execMid - b.execMid);
  let cumPV = 0;
  document.getElementById('col-priority').innerHTML = sorted.map((row, i) => {
    cumPV += row.pv;
    const cumPct  = importe > 0 ? (cumPV / importe * 100) : 0;
    const covered = cumPV >= importe;
    const justCov = covered && (cumPV - row.pv) < importe;
    const rowCls  = justCov ? 'pri-covered' : covered ? 'pri-covered' : '';
    const badge   = covered
      ? '<span style="background:#dcfce7;color:#15803d;padding:.15rem .5rem;border-radius:20px;font-size:.72rem;font-weight:700;">✓ Cubierto</span>'
      : `<span style="background:#fee2e2;color:#991b1b;padding:.15rem .5rem;border-radius:20px;font-size:.72rem;font-weight:700;">✗ Déficit ${(importe-cumPV).toFixed(2)}M€</span>`;
    return `<tr class="${rowCls}">
      <td style="font-weight:800;color:#1d4ed8;">${i+1}</td>
      <td>${row.label}</td>
      <td style="color:#64748b;">${row.desc||'—'}</td>
      <td><span style="background:#f0f4f8;border-radius:4px;padding:.15rem .4rem;font-size:.75rem;">${row.execLabel}</span></td>
      <td style="text-align:right;font-weight:700;">${row.pv.toFixed(2)} M€</td>
      <td style="text-align:right;">
        <span style="font-weight:800;color:${cumPct>=100?'#15803d':cumPct>=60?'#92400e':'#991b1b'};">${Math.min(cumPct,100).toFixed(1)}%</span>
      </td>
      <td>${badge}</td>
    </tr>`;
  }).join('');
}

// ═══════════════════════════════════════════════════════════════
// PDF EXPORT
// ═══════════════════════════════════════════════════════════════
function exportPDF() {
  // Update cover date
  const now = new Date();
  const dateStr = now.toLocaleDateString('es-ES', { day:'2-digit', month:'long', year:'numeric' });
  const el = document.getElementById('cover-date');
  if (el) el.textContent = dateStr;

  // Show cover + all sections + print headers
  const cover    = document.getElementById('pdf-cover');
  const sections = document.querySelectorAll('.section');
  const tabs     = document.querySelectorAll('.tab');
  const pHeaders = document.querySelectorAll('.print-header');

  cover.style.display    = 'flex';
  cover.style.position   = 'relative';
  cover.style.width      = '100vw';
  cover.style.height     = '100vh';
  sections.forEach(s => s.style.display = 'block');
  tabs.forEach(t => t.style.display = 'none');
  pHeaders.forEach(h => h.style.display = 'flex');

  window.print();

  // Restore after print dialog closes
  setTimeout(() => {
    cover.style.display    = 'none';
    cover.style.position   = '';
    cover.style.width      = '';
    cover.style.height     = '';
    sections.forEach(s => s.style.display = '');
    tabs.forEach(t => t.style.display = '');
    pHeaders.forEach(h => h.style.display = 'none');
    document.querySelectorAll('.section.active').forEach(s => s.style.display = 'block');
  }, 1200);
}

// ── Init ──
window.addEventListener('load', () => {
  // Load Tubacex as default example
  loadExample('tubacex');
});
</script>
</body>
</html>
